# DO-K8s

Cluster.dev uses [stack templates](https://docs.cluster.dev/stack-templates-overview/) to generate users' projects in a desired cloud. DO-K8s is a stack template that creates and provisions Kubernetes clusters in the DigitalOcean cloud.

On this page you will find guidance on how to create a Kubernetes cluster on DigitalOcean using one of the Cluster.dev prepared samples â€“ the [DO-K8s](https://github.com/shalb/cdev-do-k8s) stack template. Running the example code will have the following resources created:

* DO Kubernetes cluster with addons:

    * cert-manager

    * argocd

* *(optional, if vpc_id is not set)* VPC for Kubernetes cluster

## Prerequisites 

1. Terraform version 1.4+

2. DigitalOcean account

3. [doctl installed](https://docs.digitalocean.com/reference/doctl/how-to/install/)

4. [Cluster.dev client installed](https://docs.cluster.dev/get-started-install/)

### Authentication

Create an [access token](https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/) for a user.

!!! Info
    Make sure to grant the user with administrative permissions.

For details on using DO spaces bucket as a backend, see [here](https://www.digitalocean.com/community/questions/spaces-as-terraform-backend).

### DO access configuration

1. Install `doctl`. For more information, see [the official documentation](https://www.digitalocean.com/docs/apis-clis/doctl/how-to/install/).

    ```bash
    cd ~
    wget https://github.com/digitalocean/doctl/releases/download/v1.57.0/doctl-1.57.0-linux-amd64.tar.gz
    tar xf ~/doctl-1.57.0-linux-amd64.tar.gz
    sudo mv ~/doctl /usr/local/bin
    ```

2. Export your DIGITALOCEAN_TOKEN, for details see [here](https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/).

    ```bash
    export DIGITALOCEAN_TOKEN="MyDIGITALOCEANToken"
    ```

3. Export SPACES_ACCESS_KEY_ID and SPACES_SECRET_ACCESS_KEY environment variables, for details see [here](https://www.digitalocean.com/community/tutorials/how-to-create-a-digitalocean-space-and-api-key).

    ```bash
    export SPACES_ACCESS_KEY_ID="dSUGdbJqa6xwJ6Fo8qV2DSksdjh..."
    export SPACES_SECRET_ACCESS_KEY="TEaKjdj8DSaJl7EnOdsa..."
    ```

4. [Create a spaces bucket](https://www.digitalocean.com/docs/spaces/quickstart/#create-a-space) for Terraform states in the chosen region (in the example we used the 'cdev-data' bucket name).

5. [Create a domain](https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/) in DigitalOcean domains service.

!!! Info
    In the project generated by default we used 'k8s.cluster.dev' zone as an example. Please make sure to change it.

## Create project

1. Configure [access to DigitalOcean](#do-access-configuration) and export required variables.

2. Create locally a project directory, cd into it and execute the command:

    ```bash
      cdev project create https://github.com/shalb/cdev-do-k8s
    ```
    This will create a new empty project.

3. Edit variables in the example's files, if necessary:

    * `project.yaml` - main project config. Sets common global variables for current project such as organization, region, state bucket name etc. See [project configuration docs](https://docs.cluster.dev/structure-project/).

    * `backend.yaml` - configures backend for Cluster.dev states (including Terraform states). Uses variables from `project.yaml`. See [backend docs](https://docs.cluster.dev/structure-backend/).

    * `stack.yaml` - describes stack configuration. See [stack docs](https://docs.cluster.dev/structure-stack/).

4. Run `cdev plan` to build the project. In the output you will see an infrastructure that is going to be created after running `cdev apply`.

    !!! note
        Prior to running `cdev apply` make sure to look through the `stack.yaml` file and replace the commented fields with real values. In case you would like to use existing VPC and subnets, uncomment preset options and set correct VPC ID and subnets' IDs. If you leave them as is, Cluster.dev will have VPC and subnets created for you.

5. Run `cdev apply`

    !!! tip
        We highly recommend to run `cdev apply` in a debug mode so that you could see the Cluster.dev logging in the output: `cdev apply -l debug`

6. After `cdev apply` is successfully executed, in the output you will see the ArgoCD URL of your cluster. Sign in to the console to check whether ArgoCD is up and running and the stack template has been deployed correctly. To sign in, use the "admin" login and the bcrypted password that you have generated for the `stack.yaml`.

7. Displayed in the output will be also a command on how to get kubeconfig and connect to your Kubernetes cluster.

8. Destroy the cluster and all created resources with the command `cdev destroy`
